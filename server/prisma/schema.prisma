generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  name      String
  role      String   @default("staff") // 'admin' | 'staff'
  phone     String
  email     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  auditLogs AuditLog[]
  
  // Relations
  cleaningTasks       CleaningTask[]  @relation("CleaningAssigned")
  maintenanceTasks    MaintenanceTask[] @relation("MaintenanceAssigned")
  stockMovements      StockMovement[]
  transactions        Transaction[]
  checkIns            CheckInOut[]
  paymentVerifications PaymentSlip[]
}

model Room {
  id            String    @id @default(uuid())
  number        String    @unique
  name          String
  type          String    // 'standard' | 'deluxe' | 'family'
  status        String    @default("available") // 'available' | 'occupied' | 'cleaning' | 'maintenance' | 'reserved'
  pricePerNight Float
  capacity      Int
  amenities     String    // Stored as JSON string or comma separated
  floor         Int
  image         String?
  description   String?   // Room description
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  bookings         Booking[]
  checkIns         CheckInOut[]
  cleaningTasks    CleaningTask[]
  maintenanceTasks MaintenanceTask[]
}

model Booking {
  id            String   @id @default(uuid())
  bookingCode   String   @unique
  guestName     String
  guestPhone    String
  guestEmail    String?
  guestNote     String?
  
  roomId        String
  room          Room     @relation(fields: [roomId], references: [id])
  
  // Optional link to registered customer
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  
  checkInDate   DateTime
  checkOutDate  DateTime
  nights        Int
  adults        Int
  children      Int
  
  status        String   @default("pending") // 'pending', 'confirmed', 'checked-in', 'checked-out', 'cancelled'
  paymentStatus String   @default("pending") // 'pending', 'paid', 'refunded'
  
  roomPrice     Float
  totalAmount   Float
  paidAmount    Float    @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  checkIns      CheckInOut[]
  paymentSlips  PaymentSlip[]
  review        Review?
}

// Customer review for completed booking
model Review {
  id            String   @id @default(uuid())
  bookingId     String   @unique
  booking       Booking  @relation(fields: [bookingId], references: [id])
  
  rating        Int      // 1-5 stars
  comment       String?  // Customer comment
  
  // Rating categories (1-5)
  cleanlinessRating  Int?  // ความสะอาด
  serviceRating      Int?  // การบริการ
  locationRating     Int?  // ทำเล
  valueRating        Int?  // ความคุ้มค่า
  
  isApproved    Boolean  @default(true)  // Admin can hide inappropriate reviews
  isHighlighted Boolean  @default(false) // Featured review
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Payment slip for booking verification
model PaymentSlip {
  id            String   @id @default(uuid())
  bookingId     String
  booking       Booking  @relation(fields: [bookingId], references: [id])
  imageUrl      String   // Path to uploaded slip image
  amount        Float?   // Amount shown in slip (optional)
  status        String   @default("pending") // 'pending', 'verified', 'rejected'
  notes         String?  // Admin notes
  verifiedAt    DateTime?
  verifiedById  String?
  verifiedBy    User?    @relation(fields: [verifiedById], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Customer {
  id            String    @id @default(uuid())
  code          String    @unique  // CUS-0001
  firstName     String
  lastName      String
  phone         String
  email         String?
  idCard        String?   // เลขบัตรประชาชน/Passport
  nationality   String    @default("Thai")
  address       String?
  notes         String?
  totalVisits   Int       @default(0)
  totalSpent    Float     @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  bookings      Booking[]
  checkIns      CheckInOut[]
}

model CheckInOut {
  id            String    @id @default(uuid())
  
  bookingId     String
  booking       Booking   @relation(fields: [bookingId], references: [id])
  
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  
  roomId        String
  room          Room      @relation(fields: [roomId], references: [id])
  
  type          String    // 'check-in' | 'check-out'
  datetime      DateTime  @default(now())
  
  staffId       String
  staff         User      @relation(fields: [staffId], references: [id])
  
  notes         String?
  createdAt     DateTime  @default(now())
}

model Product {
  id        String      @id @default(uuid())
  code      String      @unique
  name      String
  category  String      // 'beverage', 'alcohol', ...
  price     Float
  stock     Int
  unit      String
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  // Relations
  orderItems     OrderItem[]
  stockMovements StockMovement[]
}

model Order {
  id            String      @id @default(uuid())
  orderCode     String      @unique
  
  roomId        String?     // Optional, link to room if room service
  roomNumber    String?
  guestName     String?
  
  subtotal      Float
  discount      Float       @default(0)
  total         Float
  
  paymentMethod String      // 'cash', 'transfer'
  status        String      @default("completed") // 'completed', 'cancelled'
  
  items         OrderItem[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  productName String
  price       Float
  quantity    Int
}

model CleaningTask {
  id            String    @id @default(uuid())
  roomId        String
  room          Room      @relation(fields: [roomId], references: [id])
  
  type          String    // 'checkout' | 'routine' | 'deep'
  status        String    @default("pending") // 'pending' | 'in-progress' | 'completed'
  priority      String    @default("normal") // 'low' | 'normal' | 'high' | 'urgent'
  notes         String?
  
  assignedToId  String?
  assignedTo    User?     @relation("CleaningAssigned", fields: [assignedToId], references: [id])
  
  startedAt     DateTime?
  completedAt   DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model MaintenanceTask {
  id            String    @id @default(uuid())
  roomId        String?
  room          Room?     @relation(fields: [roomId], references: [id])
  
  location      String?   // หากไม่ใช่ห้องพัก เช่น "Lobby", "Pool"
  title         String
  description   String?
  category      String    // 'electrical' | 'plumbing' | 'ac' | 'furniture' | 'general'
  
  status        String    @default("pending") // 'pending' | 'in-progress' | 'completed' | 'cancelled'
  priority      String    @default("normal")
  
  estimatedCost Float?
  actualCost    Float?
  
  assignedToId  String?
  assignedTo    User?     @relation("MaintenanceAssigned", fields: [assignedToId], references: [id])
  
  startedAt     DateTime?
  completedAt   DateTime?
  
  images        String?   // JSON array of image URLs
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model StockMovement {
  id            String    @id @default(uuid())
  productId     String
  product       Product   @relation(fields: [productId], references: [id])
  
  type          String    // 'in' | 'out' | 'adjustment'
  quantity      Int
  reason        String    // 'purchase' | 'sale' | 'damaged' | 'expired' | 'adjustment' | 'transfer'
  reference     String?   // Order ID, Purchase ID, etc.
  notes         String?
  
  staffId       String
  staff         User      @relation(fields: [staffId], references: [id])
  
  createdAt     DateTime  @default(now())
}

model Transaction {
  id            String    @id @default(uuid())
  code          String    @unique  // TXN-0001
  type          String    // 'income' | 'expense'
  category      String    // 'room' | 'bar' | 'service' | 'salary' | 'utility' | 'maintenance' | 'supplies' | 'other'
  amount        Float
  paymentMethod String    // 'cash' | 'transfer' | 'credit'
  reference     String?   // Booking ID, Order ID, etc.
  description   String?
  date          DateTime  @default(now())
  
  staffId       String
  staff         User      @relation(fields: [staffId], references: [id])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Setting {
  id            String    @id @default(uuid())
  key           String    @unique
  value         String
  type          String    @default("string") // 'string' | 'number' | 'boolean' | 'json'
  category      String    @default("general") // 'general' | 'booking' | 'payment' | 'notification'
  description   String?
  updatedAt     DateTime  @updatedAt
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   // CREATE_BOOKING, UPDATE_BOOKING, etc.
  entityType  String   // 'booking', 'room', 'user', etc.
  entityId    String
  details     String?  // JSON string of additional details
  ipAddress   String?
  createdAt   DateTime @default(now())
}
